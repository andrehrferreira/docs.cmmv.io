<h1>Cache</h1><a id="cache" title="Cache"></a>
<p>The <code>@cmmv/cache</code> module integrates with <code>cache-manager</code> to provide in-memory cache management. By default, it includes support for Redis using the <code>@tirke/node-cache-manager-ioredis</code> package, but it also supports other cache stores that are compatible with <code>cache-manager</code>.</p>
<p>To install the <code>@cmmv/cache</code> module, use npm:</p>
<div class="code-block-container">
                <button class="copy-code-btn" onclick="copyToClipboard(this)" title="Copy">
                    <i class="fa-regular fa-clone"></i>
                </button>
                <pre><code class="hljs language-bash" lang="bash"">$ pnpm add @cmmv/cache
</code></pre>
             </div>
<p>If you’re planning to use Redis or other stores, you’ll need to install the appropriate package based on the cache store you intend to use.</p>
<p><strong>Supported Cache Stores and Drivers</strong></p>
<p><code>cache-manager</code> supports various cache stores, and you can configure your store based on your requirements. Here are the supported stores and their respective drivers:</p>
<p><strong>Redis:</strong> <a href="https://github.com/Tirke/node-cache-manager-stores/tree/main" target="_blank" rel="nofollow">Github</a></p>
<div class="code-block-container">
                <button class="copy-code-btn" onclick="copyToClipboard(this)" title="Copy">
                    <i class="fa-regular fa-clone"></i>
                </button>
                <pre><code class="hljs language-bash" lang="bash"">$ pnpm add @tirke/node-cache-manager-ioredis
</code></pre>
             </div>
<p><strong>Memcached:</strong> <a href="https://github.com/theogravity/node-cache-manager-memcached-store" target="_blank" rel="nofollow">Github</a></p>
<div class="code-block-container">
                <button class="copy-code-btn" onclick="copyToClipboard(this)" title="Copy">
                    <i class="fa-regular fa-clone"></i>
                </button>
                <pre><code class="hljs language-bash" lang="bash"">$ pnpm add cache-manager-memcached-store
</code></pre>
             </div>
<p><strong>MongoDB:</strong> <a href="https://github.com/v4l3r10/node-cache-manager-mongodb" target="_blank" rel="nofollow">Github</a></p>
<div class="code-block-container">
                <button class="copy-code-btn" onclick="copyToClipboard(this)" title="Copy">
                    <i class="fa-regular fa-clone"></i>
                </button>
                <pre><code class="hljs language-bash" lang="bash"">$ pnpm add cache-manager-mongodb
</code></pre>
             </div>
<p><strong>Filesystem Binary:</strong> <a href="https://github.com/sheershoff/node-cache-manager-fs-binary" target="_blank" rel="nofollow">Github</a></p>
<div class="code-block-container">
                <button class="copy-code-btn" onclick="copyToClipboard(this)" title="Copy">
                    <i class="fa-regular fa-clone"></i>
                </button>
                <pre><code class="hljs language-bash" lang="bash"">$ pnpm add cache-manager-fs-binary
</code></pre>
             </div>
<h2>Configuration</h2><a id="configuration" title="Configuration"></a>
<div class="code-block-container">
                <button class="copy-code-btn" onclick="copyToClipboard(this)" title="Copy">
                    <i class="fa-regular fa-clone"></i>
                </button>
                <pre><code class="hljs language-javascript" lang="javascript""><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
   <span class="hljs-comment">// Other configurations</span>

   <span class="hljs-attr">cache</span>: {
        <span class="hljs-attr">store</span>: <span class="hljs-string">&quot;@tirke/node-cache-manager-ioredis&quot;</span>,
        <span class="hljs-attr">getter</span>: <span class="hljs-string">&quot;ioRedisStore&quot;</span>,
        <span class="hljs-attr">host</span>: <span class="hljs-string">&quot;localhost&quot;</span>,
        <span class="hljs-attr">port</span>: <span class="hljs-number">6379</span>,
        <span class="hljs-attr">ttl</span>: <span class="hljs-number">600</span> <span class="hljs-comment">// Cache TTL (Time-to-Live) in seconds</span>
    },
}
</code></pre>
             </div>
<br/>
<ul>
<li><strong>store:</strong> Defines the cache store type (<code>cache-manager-redis</code> in this case).</li>
<li><strong>host:</strong> Specifies the Redis host.</li>
<li><strong>port:</strong> Specifies the Redis port.</li>
<li><strong>ttl:</strong> Defines the default time-to-live for cache entries (in seconds).</li>
</ul>
<p>To find out all the possible configurations, visit <a href="https://www.npmjs.com/package/cache-manager" target="_blank" rel="nofollow">NPM</a></p>
<h2>Cache Decorator</h2><a id="cache-decorator" title="Cache Decorator"></a>
<p>In this example, we demonstrate how to manually implement caching using the <code>@cmmv/cache</code> module in a controller generated by <code>@cmmv/http</code>. Caching can be added at various levels, including for specific endpoints or manually after certain operations, like adding or updating records.</p>
<ul>
<li><strong>Controller:</strong> <code>TaskController</code> is responsible for handling requests related to tasks.</li>
<li><strong>Cache Decorator:</strong> The <code>@Cache</code> decorator is used to cache responses automatically for GET endpoints. In this case, <code>task:getAll</code> and <code>task:{id}</code> are cached for 300 seconds with compression.</li>
<li><strong>CacheService:</strong> For <code>POST</code>, <code>PUT</code>, and <code>DELETE</code> operations, the cache is updated or removed manually using the <code>CacheService</code> API.</li>
</ul>
<div class="code-block-container">
                <button class="copy-code-btn" onclick="copyToClipboard(this)" title="Copy">
                    <i class="fa-regular fa-clone"></i>
                </button>
                <pre><code class="hljs language-typescript" lang="typescript""><span class="hljs-comment">// Generated automatically by CMMV</span>
    
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Telemetry</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@cmmv/core&quot;</span>;  
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Cache</span>, <span class="hljs-title class_">CacheService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@cmmv/cache&quot;</span>; 

<span class="hljs-keyword">import</span> { 
    <span class="hljs-title class_">Controller</span>, <span class="hljs-title class_">Get</span>, <span class="hljs-title class_">Post</span>, <span class="hljs-title class_">Put</span>, <span class="hljs-title class_">Delete</span>, 
    <span class="hljs-title class_">Queries</span>, <span class="hljs-title class_">Param</span>, <span class="hljs-title class_">Body</span>, <span class="hljs-title class_">Request</span> 
} <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@cmmv/http&#x27;</span>;

<span class="hljs-keyword">import</span> { <span class="hljs-title class_">TaskService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../services/task.service&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Task</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../models/task.model&#x27;</span>;

<span class="hljs-meta">@Controller</span>(<span class="hljs-string">&#x27;task&#x27;</span>)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TaskController</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">taskservice</span>: <span class="hljs-title class_">TaskService</span></span>) {}

    <span class="hljs-comment">// GET All Tasks with Cache</span>
    <span class="hljs-meta">@Get</span>()
    <span class="hljs-meta">@Cache</span>(<span class="hljs-string">&quot;task:getAll&quot;</span>, { <span class="hljs-attr">ttl</span>: <span class="hljs-number">300</span>, <span class="hljs-attr">compress</span>: <span class="hljs-literal">true</span> })
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">getAll</span>(<span class="hljs-meta">@Queries</span>() <span class="hljs-attr">queries</span>: <span class="hljs-built_in">any</span>, <span class="hljs-meta">@Request</span>() req): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Task</span>[]&gt; {
        <span class="hljs-title class_">Telemetry</span>.<span class="hljs-title function_">start</span>(<span class="hljs-string">&#x27;TaskController::GetAll&#x27;</span>, req.<span class="hljs-property">requestId</span>);
        <span class="hljs-keyword">let</span> result = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskservice</span>.<span class="hljs-title function_">getAll</span>(queries, req);
        <span class="hljs-title class_">Telemetry</span>.<span class="hljs-title function_">end</span>(<span class="hljs-string">&#x27;TaskController::GetAll&#x27;</span>, req.<span class="hljs-property">requestId</span>);
        <span class="hljs-keyword">return</span> result;
    }

    <span class="hljs-comment">// GET Task by ID with Cache</span>
    <span class="hljs-meta">@Get</span>(<span class="hljs-string">&#x27;:id&#x27;</span>)
    <span class="hljs-meta">@Cache</span>(<span class="hljs-string">&quot;task:{id}&quot;</span>, { <span class="hljs-attr">ttl</span>: <span class="hljs-number">300</span>, <span class="hljs-attr">compress</span>: <span class="hljs-literal">true</span> })
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">getById</span>(<span class="hljs-meta">@Param</span>(<span class="hljs-string">&#x27;id&#x27;</span>) <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>, <span class="hljs-meta">@Request</span>() req): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Task</span>&gt; {
        <span class="hljs-title class_">Telemetry</span>.<span class="hljs-title function_">start</span>(<span class="hljs-string">&#x27;TaskController::GetById&#x27;</span>, req.<span class="hljs-property">requestId</span>);
        <span class="hljs-keyword">let</span> result = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskservice</span>.<span class="hljs-title function_">getById</span>(id, req);
        <span class="hljs-title class_">Telemetry</span>.<span class="hljs-title function_">end</span>(<span class="hljs-string">&#x27;TaskController::GetById&#x27;</span>, req.<span class="hljs-property">requestId</span>);
        <span class="hljs-keyword">return</span> result;
    }

    <span class="hljs-comment">// POST (Add Task) and Update Cache</span>
    <span class="hljs-meta">@Post</span>()
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">add</span>(<span class="hljs-meta">@Body</span>() <span class="hljs-attr">item</span>: <span class="hljs-title class_">Task</span>, <span class="hljs-meta">@Request</span>() req): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Task</span>&gt; {
        <span class="hljs-title class_">Telemetry</span>.<span class="hljs-title function_">start</span>(<span class="hljs-string">&#x27;TaskController::Add&#x27;</span>, req.<span class="hljs-property">requestId</span>);
        <span class="hljs-keyword">let</span> result = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskservice</span>.<span class="hljs-title function_">add</span>(item, req);
        
        <span class="hljs-comment">// Cache the result of the newly created task</span>
        <span class="hljs-title class_">CacheService</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">`task:<span class="hljs-subst">${result.id}</span>`</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(result), <span class="hljs-number">300</span>);
        
        <span class="hljs-title class_">Telemetry</span>.<span class="hljs-title function_">end</span>(<span class="hljs-string">&#x27;TaskController::Add&#x27;</span>, req.<span class="hljs-property">requestId</span>);
        <span class="hljs-keyword">return</span> result;
    }

    <span class="hljs-comment">// PUT (Update Task) and Update Cache</span>
    <span class="hljs-meta">@Put</span>(<span class="hljs-string">&#x27;:id&#x27;</span>)
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">update</span>(
        <span class="hljs-meta">@Param</span>(<span class="hljs-string">&#x27;id&#x27;</span>) <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>, <span class="hljs-meta">@Body</span>() <span class="hljs-attr">item</span>: <span class="hljs-title class_">Task</span>, <span class="hljs-meta">@Request</span>() req
    ): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Task</span>&gt; {
        <span class="hljs-title class_">Telemetry</span>.<span class="hljs-title function_">start</span>(<span class="hljs-string">&#x27;TaskController::Update&#x27;</span>, req.<span class="hljs-property">requestId</span>);
        <span class="hljs-keyword">let</span> result = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskservice</span>.<span class="hljs-title function_">update</span>(id, item, req);
        
        <span class="hljs-comment">// Update the cache with the updated task</span>
        <span class="hljs-title class_">CacheService</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">`task:<span class="hljs-subst">${result.id}</span>`</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(result), <span class="hljs-number">300</span>);
        
        <span class="hljs-title class_">Telemetry</span>.<span class="hljs-title function_">end</span>(<span class="hljs-string">&#x27;TaskController::Update&#x27;</span>, req.<span class="hljs-property">requestId</span>);
        <span class="hljs-keyword">return</span> result;
    }

    <span class="hljs-comment">// DELETE (Remove Task) and Clear Cache</span>
    <span class="hljs-meta">@Delete</span>(<span class="hljs-string">&#x27;:id&#x27;</span>)
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">delete</span>(
        <span class="hljs-meta">@Param</span>(<span class="hljs-string">&#x27;id&#x27;</span>) <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>, <span class="hljs-meta">@Request</span>() req
    ): <span class="hljs-title class_">Promise</span>&lt;{ <span class="hljs-attr">success</span>: <span class="hljs-built_in">boolean</span>, <span class="hljs-attr">affected</span>: <span class="hljs-built_in">number</span> }&gt; {
        <span class="hljs-title class_">Telemetry</span>.<span class="hljs-title function_">start</span>(<span class="hljs-string">&#x27;TaskController::Delete&#x27;</span>, req.<span class="hljs-property">requestId</span>);
        <span class="hljs-keyword">let</span> result = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskservice</span>.<span class="hljs-title function_">delete</span>(id, req);
        
        <span class="hljs-comment">// Remove the deleted task from the cache</span>
        <span class="hljs-title class_">CacheService</span>.<span class="hljs-title function_">del</span>(<span class="hljs-string">`task:<span class="hljs-subst">${id}</span>`</span>);
        
        <span class="hljs-title class_">Telemetry</span>.<span class="hljs-title function_">end</span>(<span class="hljs-string">&#x27;TaskController::Delete&#x27;</span>, req.<span class="hljs-property">requestId</span>);
        <span class="hljs-keyword">return</span> result;
    }
}
</code></pre>
             </div>
<p><strong>Caching on GET Requests:</strong></p>
<ul>
<li><strong>Automatic Caching:</strong> The @Cache decorator is applied to the getAll and getById methods. Cached results are automatically stored and retrieved based on the key pattern, reducing database load and improving performance.</li>
<li><strong>Cache Key:</strong> Cache keys are defined as task:getAll for retrieving all tasks, and task:{id} for retrieving a task by ID.<br>
TTL (Time-to-Live): The cached results are valid for 300 seconds.</li>
</ul>
<p><strong>Manual Caching for <code>POST</code>, <code>PUT</code>, and <code>DELETE</code>:</strong></p>
<ul>
<li>For <code>POST</code> (creating a new task) and <code>PUT</code> (updating a task), the <code>CacheService.set</code> method is used to manually update the cache with the new or updated task.</li>
<li>For <code>DELETE</code> (removing a task), the <code>CacheService.del</code> method is used to remove the corresponding cache entry after the task is deleted.</li>
<li><strong>Telemetry:</strong> Tracks and logs the execution of each method, useful for performance monitoring.</li>
</ul>
<p>This setup optimizes response time by caching frequently accessed data while ensuring that cache entries are updated or cleared when data is modified.</p>
<h2>Contract Settings</h2><a id="contract-settings" title="Contract Settings"></a>
<p>The <code>@cmmv/cache</code> module provides the <code>Cache</code> decorator, which can be applied to any controller, gateway, or specific methods. This decorator is useful for automatically caching responses for specific routes.</p>
<p>In the following example, cache properties are added to a contract using the <code>@Contract</code> decorator. This enables caching for the associated controller and gateway routes automatically generated by the transpiler.</p>
<div class="code-block-container">
                <button class="copy-code-btn" onclick="copyToClipboard(this)" title="Copy">
                    <i class="fa-regular fa-clone"></i>
                </button>
                <pre><code class="hljs language-typescript" lang="typescript""><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AbstractContract</span>, <span class="hljs-title class_">Contract</span>, <span class="hljs-title class_">ContractField</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@cmmv/core&#x27;</span>;

<span class="hljs-meta">@Contract</span>({
    <span class="hljs-attr">controllerName</span>: <span class="hljs-string">&#x27;Task&#x27;</span>,
    <span class="hljs-attr">protoPath</span>: <span class="hljs-string">&#x27;src/protos/task.proto&#x27;</span>,
    <span class="hljs-attr">protoPackage</span>: <span class="hljs-string">&#x27;task&#x27;</span>,
    <span class="hljs-attr">cache</span>: { 
        <span class="hljs-attr">key</span>: <span class="hljs-string">&quot;task:&quot;</span>,   <span class="hljs-comment">// Cache key prefix</span>
        <span class="hljs-attr">ttl</span>: <span class="hljs-number">300</span>,       <span class="hljs-comment">// Time-to-live (in seconds)</span>
        <span class="hljs-attr">compress</span>: <span class="hljs-literal">true</span>  <span class="hljs-comment">// Enable compression for stored data</span>
    }
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TasksContract</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">AbstractContract</span> {
    <span class="hljs-meta">@ContractField</span>({
        <span class="hljs-attr">protoType</span>: <span class="hljs-string">&#x27;string&#x27;</span>,
        <span class="hljs-attr">unique</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">validations</span>: [
            {
                <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;IsString&#x27;</span>,
                <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;Invalid label&#x27;</span>,
            },
            {
                <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;IsNotEmpty&#x27;</span>,
                <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;Invalid label&#x27;</span>,
            },
        ],
    })
    <span class="hljs-attr">label</span>: <span class="hljs-built_in">string</span>;

    <span class="hljs-meta">@ContractField</span>({
        <span class="hljs-attr">protoType</span>: <span class="hljs-string">&#x27;bool&#x27;</span>,
        <span class="hljs-attr">defaultValue</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">validations</span>: [
            {
                <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;IsBoolean&#x27;</span>,
                <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;Invalid checked type&#x27;</span>,
            },
        ],
    })
    <span class="hljs-attr">checked</span>: <span class="hljs-built_in">boolean</span>;

    <span class="hljs-meta">@ContractField</span>({
        <span class="hljs-attr">protoType</span>: <span class="hljs-string">&#x27;bool&#x27;</span>,
        <span class="hljs-attr">defaultValue</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">validations</span>: [
            {
                <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;IsBoolean&#x27;</span>,
                <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;Invalid removed type&#x27;</span>,
            },
        ],
    })
    <span class="hljs-attr">removed</span>: <span class="hljs-built_in">boolean</span>;
}
</code></pre>
             </div>
<h2>Cache Properties</h2><a id="cache-properties" title="Cache Properties"></a>
<ul>
<li><strong>key:</strong> A prefix for the cache key. In the example above, it is <code>&quot;task:&quot;</code>. For a <code>getAll</code> request, the cached result will be stored as <code>task:getAll</code>.</li>
<li><strong>ttl:</strong> The time-to-live for cached data. After 300 seconds, the cache entry will expire.</li>
<li><strong>compress:</strong> Enables compression of the data before storing it in the cache to reduce memory usage.</li>
</ul>
<p>If you need more advanced caching strategies or custom store integrations, you can customize the cache settings in the <code>.cmmv.config.js</code> file or extend the existing cache functionalities within your project. For example, you could add custom cache strategies like memory caching, database caching, or even multi-level caching.</p>
<h2>Controllers</h2><a id="controllers" title="Controllers"></a>
<p>When the <code>@cmmv/cache</code> module is included in the project, the automatically generated controllers from <code>@cmmv/http</code> are modified to include caching functionalities. The caching configuration is defined directly in the contract using the cache property. Here’s how the controller is altered:</p>
<div class="code-block-container">
                <button class="copy-code-btn" onclick="copyToClipboard(this)" title="Copy">
                    <i class="fa-regular fa-clone"></i>
                </button>
                <pre><code class="hljs language-typescript" lang="typescript""><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AbstractContract</span>, <span class="hljs-title class_">Contract</span>, <span class="hljs-title class_">ContractField</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@cmmv/core&#x27;</span>;

<span class="hljs-meta">@Contract</span>({
    <span class="hljs-attr">controllerName</span>: <span class="hljs-string">&#x27;Task&#x27;</span>,
    <span class="hljs-attr">protoPath</span>: <span class="hljs-string">&#x27;src/protos/task.proto&#x27;</span>,
    <span class="hljs-attr">protoPackage</span>: <span class="hljs-string">&#x27;task&#x27;</span>,
    <span class="hljs-attr">cache</span>: { 
        <span class="hljs-attr">key</span>: <span class="hljs-string">&quot;task:&quot;</span>, 
        ttl : <span class="hljs-number">300</span>, 
        <span class="hljs-attr">compress</span>: <span class="hljs-literal">true</span> 
    }
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TasksContract</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">AbstractContract</span> {
    <span class="hljs-meta">@ContractField</span>({
        <span class="hljs-attr">protoType</span>: <span class="hljs-string">&#x27;string&#x27;</span>,
        <span class="hljs-attr">unique</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">validations</span>: [
            {
                <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;IsString&#x27;</span>,
                <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;Invalid label&#x27;</span>,
            },
            {
                <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;IsNotEmpty&#x27;</span>,
                <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;Label cannot be empty&#x27;</span>,
            },
        ],
    })
    <span class="hljs-attr">label</span>: <span class="hljs-built_in">string</span>;

    <span class="hljs-meta">@ContractField</span>({
        <span class="hljs-attr">protoType</span>: <span class="hljs-string">&#x27;bool&#x27;</span>,
        <span class="hljs-attr">defaultValue</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">validations</span>: [
            {
                <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;IsBoolean&#x27;</span>,
                <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;Checked value must be a boolean&#x27;</span>,
            },
        ],
    })
    <span class="hljs-attr">checked</span>: <span class="hljs-built_in">boolean</span>;

    <span class="hljs-meta">@ContractField</span>({
        <span class="hljs-attr">protoType</span>: <span class="hljs-string">&#x27;bool&#x27;</span>,
        <span class="hljs-attr">defaultValue</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">validations</span>: [
            {
                <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;IsBoolean&#x27;</span>,
                <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;Removed value must be a boolean&#x27;</span>,
            },
        ],
    })
    <span class="hljs-attr">removed</span>: <span class="hljs-built_in">boolean</span>;
}
</code></pre>
             </div>
<p>Based on the above contract with cache configuration, the generated controller will include caching logic using the <code>@Cache</code> decorator from <code>@cmmv/cache</code>. Here’s an example of how the controller is generated:</p>
<div class="code-block-container">
                <button class="copy-code-btn" onclick="copyToClipboard(this)" title="Copy">
                    <i class="fa-regular fa-clone"></i>
                </button>
                <pre><code class="hljs language-typescript" lang="typescript""><span class="hljs-comment">// Generated automatically by CMMV</span>

<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Telemetry</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@cmmv/core&quot;</span>;  
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Cache</span>, <span class="hljs-title class_">CacheService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@cmmv/cache&quot;</span>; 

<span class="hljs-keyword">import</span> { 
    <span class="hljs-title class_">Controller</span>, <span class="hljs-title class_">Get</span>, <span class="hljs-title class_">Post</span>, <span class="hljs-title class_">Put</span>, <span class="hljs-title class_">Delete</span>, 
    <span class="hljs-title class_">Queries</span>, <span class="hljs-title class_">Param</span>, <span class="hljs-title class_">Body</span>, <span class="hljs-title class_">Request</span> 
} <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@cmmv/http&#x27;</span>;

<span class="hljs-keyword">import</span> { <span class="hljs-title class_">TaskService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../services/task.service&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Task</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../models/task.model&#x27;</span>;

<span class="hljs-meta">@Controller</span>(<span class="hljs-string">&#x27;task&#x27;</span>)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TaskController</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">taskservice</span>: <span class="hljs-title class_">TaskService</span></span>) {}

    <span class="hljs-meta">@Get</span>()
    <span class="hljs-meta">@Cache</span>(<span class="hljs-string">&quot;task:getAll&quot;</span>, { <span class="hljs-attr">ttl</span>: <span class="hljs-number">300</span>, <span class="hljs-attr">compress</span>: <span class="hljs-literal">true</span> })
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">getAll</span>(<span class="hljs-meta">@Queries</span>() <span class="hljs-attr">queries</span>: <span class="hljs-built_in">any</span>, <span class="hljs-meta">@Request</span>() req): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Task</span>[]&gt; {
        <span class="hljs-title class_">Telemetry</span>.<span class="hljs-title function_">start</span>(<span class="hljs-string">&#x27;TaskController::GetAll&#x27;</span>, req.<span class="hljs-property">requestId</span>);
        <span class="hljs-keyword">let</span> result = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskservice</span>.<span class="hljs-title function_">getAll</span>(queries, req);
        <span class="hljs-title class_">Telemetry</span>.<span class="hljs-title function_">end</span>(<span class="hljs-string">&#x27;TaskController::GetAll&#x27;</span>, req.<span class="hljs-property">requestId</span>);
        <span class="hljs-keyword">return</span> result;
    }

    <span class="hljs-meta">@Get</span>(<span class="hljs-string">&#x27;:id&#x27;</span>)
    <span class="hljs-meta">@Cache</span>(<span class="hljs-string">&quot;task:{id}&quot;</span>, { <span class="hljs-attr">ttl</span>: <span class="hljs-number">300</span>, <span class="hljs-attr">compress</span>: <span class="hljs-literal">true</span> })
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">getById</span>(<span class="hljs-meta">@Param</span>(<span class="hljs-string">&#x27;id&#x27;</span>) <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>, <span class="hljs-meta">@Request</span>() req): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Task</span>&gt; {
        <span class="hljs-title class_">Telemetry</span>.<span class="hljs-title function_">start</span>(<span class="hljs-string">&#x27;TaskController::GetById&#x27;</span>, req.<span class="hljs-property">requestId</span>);
        <span class="hljs-keyword">let</span> result = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskservice</span>.<span class="hljs-title function_">getById</span>(id, req);
        <span class="hljs-title class_">Telemetry</span>.<span class="hljs-title function_">end</span>(<span class="hljs-string">&#x27;TaskController::GetById&#x27;</span>, req.<span class="hljs-property">requestId</span>);
        <span class="hljs-keyword">return</span> result;
    }

    <span class="hljs-meta">@Post</span>()
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">add</span>(<span class="hljs-meta">@Body</span>() <span class="hljs-attr">item</span>: <span class="hljs-title class_">Task</span>, <span class="hljs-meta">@Request</span>() req): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Task</span>&gt; {
        <span class="hljs-title class_">Telemetry</span>.<span class="hljs-title function_">start</span>(<span class="hljs-string">&#x27;TaskController::Add&#x27;</span>, req.<span class="hljs-property">requestId</span>);
        <span class="hljs-keyword">let</span> result = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskservice</span>.<span class="hljs-title function_">add</span>(item, req);
        <span class="hljs-title class_">CacheService</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">`task:<span class="hljs-subst">${result.id}</span>`</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(result), <span class="hljs-number">300</span>);
        <span class="hljs-title class_">Telemetry</span>.<span class="hljs-title function_">end</span>(<span class="hljs-string">&#x27;TaskController::Add&#x27;</span>, req.<span class="hljs-property">requestId</span>);
        <span class="hljs-keyword">return</span> result;
    }

    <span class="hljs-meta">@Put</span>(<span class="hljs-string">&#x27;:id&#x27;</span>)
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">update</span>(
        <span class="hljs-meta">@Param</span>(<span class="hljs-string">&#x27;id&#x27;</span>) <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>, <span class="hljs-meta">@Body</span>() <span class="hljs-attr">item</span>: <span class="hljs-title class_">Task</span>, <span class="hljs-meta">@Request</span>() req
    ): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Task</span>&gt; {
        <span class="hljs-title class_">Telemetry</span>.<span class="hljs-title function_">start</span>(<span class="hljs-string">&#x27;TaskController::Update&#x27;</span>, req.<span class="hljs-property">requestId</span>);
        <span class="hljs-keyword">let</span> result = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskservice</span>.<span class="hljs-title function_">update</span>(id, item, req);
        <span class="hljs-title class_">CacheService</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">`task:<span class="hljs-subst">${result.id}</span>`</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(result), <span class="hljs-number">300</span>);
        <span class="hljs-title class_">Telemetry</span>.<span class="hljs-title function_">end</span>(<span class="hljs-string">&#x27;TaskController::Update&#x27;</span>, req.<span class="hljs-property">requestId</span>);
        <span class="hljs-keyword">return</span> result;
    }

    <span class="hljs-meta">@Delete</span>(<span class="hljs-string">&#x27;:id&#x27;</span>)
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">delete</span>(
        <span class="hljs-meta">@Param</span>(<span class="hljs-string">&#x27;id&#x27;</span>) <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>, <span class="hljs-meta">@Request</span>() req
    ): <span class="hljs-title class_">Promise</span>&lt;{ <span class="hljs-attr">success</span>: <span class="hljs-built_in">boolean</span>, <span class="hljs-attr">affected</span>: <span class="hljs-built_in">number</span> }&gt; {
        <span class="hljs-title class_">Telemetry</span>.<span class="hljs-title function_">start</span>(<span class="hljs-string">&#x27;TaskController::Delete&#x27;</span>, req.<span class="hljs-property">requestId</span>);
        <span class="hljs-keyword">let</span> result = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskservice</span>.<span class="hljs-title function_">delete</span>(id, req);
        <span class="hljs-title class_">CacheService</span>.<span class="hljs-title function_">del</span>(<span class="hljs-string">`task:<span class="hljs-subst">${id}</span>`</span>);
        <span class="hljs-title class_">Telemetry</span>.<span class="hljs-title function_">end</span>(<span class="hljs-string">&#x27;TaskController::Delete&#x27;</span>, req.<span class="hljs-property">requestId</span>);
        <span class="hljs-keyword">return</span> result;
    }
}
</code></pre>
             </div>
<ul>
<li>
<p><strong>Cache Decorator:</strong> The <code>@Cache</code> decorator is added to methods like <code>getAll</code> and <code>getById</code> based on the cache configuration provided in the contract. This decorator automatically caches the results for the specified time (<code>ttl</code>) and applies compression (<code>compress</code>) if configured.</p>
</li>
<li>
<p><strong><code>@Cache(&quot;task:getAll&quot;, { ttl: 300, compress: true })</code>:</strong> This line configures caching for the <code>getAll method</code>, where the cache key is <code>task:getAll</code>, with a TTL of 300 seconds, and compresses the cached data.</p>
</li>
<li>
<p><strong>Manual Cache Management:</strong> In <code>add</code>, <code>update</code>, and <code>delete</code> methods, manual cache management is applied. The <code>CacheService.set</code> and <code>CacheService.del</code> methods are used to update or delete cached data.</p>
</li>
<li>
<p><strong><code>CacheService.set(&quot;task:{id}&quot;, JSON.stringify(result), 300)</code>:</strong> Manually sets the cache for a specific task after adding or updating it.</p>
</li>
<li>
<p><strong><code>CacheService.del(&quot;task:{id}&quot;)</code>:</strong> Deletes the cache for a specific task after it is deleted.</p>
</li>
<li>
<p><strong>Dynamic Cache Keys:</strong> The cache keys are dynamic, as shown in the <code>getById</code>, <code>add</code>, <code>update</code>, and <code>delete</code> methods, where the task ID is part of the cache key.</p>
</li>
</ul>
<p>The <code>@cmmv/cache</code> module enhances the generated controllers by adding automatic and manual caching capabilities based on the contract’s cache configuration. The <code>@Cache</code> decorator is applied to methods where needed, and the <code>CacheService</code> is used to manage cache entries for specific tasks or resources. This ensures better performance by reducing redundant database queries or service calls.</p>
<h2>Gateways</h2><a id="gateways" title="Gateways"></a>
<p>When the <code>@cmmv/cache</code> module is present in the project, gateways generated by the <code>@cmmv/ws</code> module are modified to include caching functionality. The cache configuration can be defined in the contract and impacts how RPC messages are handled.</p>
<ul>
<li>
<p><strong>Cache Decorator:</strong> The <code>@Cache</code> decorator is applied to message handlers in the gateway, enabling automatic caching of responses. The cache key, TTL (time-to-live), and compression options are based on the configuration from the contract.</p>
</li>
<li>
<p><strong>Manual Cache Management:</strong> Cache entries are manually updated or deleted when new data is added or modified, ensuring that the cache remains consistent with the latest data.</p>
</li>
</ul>
<div class="code-block-container">
                <button class="copy-code-btn" onclick="copyToClipboard(this)" title="Copy">
                    <i class="fa-regular fa-clone"></i>
                </button>
                <pre><code class="hljs language-typescript" lang="typescript""><span class="hljs-comment">// Generated automatically by CMMV</span>

<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Rpc</span>, <span class="hljs-title class_">Message</span>, <span class="hljs-title class_">Data</span>, <span class="hljs-title class_">Socket</span>, <span class="hljs-title class_">RpcUtils</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@cmmv/ws&quot;</span>;
<span class="hljs-keyword">import</span> { plainToClass } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;class-transformer&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">TaskEntity</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../entities/task.entity&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Cache</span>, <span class="hljs-title class_">CacheService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@cmmv/cache&quot;</span>; <span class="hljs-comment">// Cache module</span>

<span class="hljs-keyword">import</span> { 
    <span class="hljs-title class_">AddTaskRequest</span>, 
    <span class="hljs-title class_">UpdateTaskRequest</span>,   
    <span class="hljs-title class_">DeleteTaskRequest</span> 
} <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;../protos/task&quot;</span>;

<span class="hljs-keyword">import</span> { <span class="hljs-title class_">TaskService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../services/task.service&#x27;</span>;

<span class="hljs-meta">@Rpc</span>(<span class="hljs-string">&quot;task&quot;</span>)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TaskGateway</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">taskservice</span>: <span class="hljs-title class_">TaskService</span></span>) {}

    <span class="hljs-meta">@Message</span>(<span class="hljs-string">&quot;GetAllTaskRequest&quot;</span>)
    <span class="hljs-meta">@Cache</span>(<span class="hljs-string">&quot;task:getAll&quot;</span>, { <span class="hljs-attr">ttl</span>: <span class="hljs-number">300</span>, <span class="hljs-attr">compress</span>: <span class="hljs-literal">true</span> }) <span class="hljs-comment">// Cache decorator</span>
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">getAll</span>(<span class="hljs-params"><span class="hljs-meta">@Socket</span>() socket</span>) {
        <span class="hljs-keyword">const</span> items = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskservice</span>.<span class="hljs-title function_">getAll</span>();

        <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title class_">RpcUtils</span>.<span class="hljs-title function_">pack</span>(
            <span class="hljs-string">&quot;task&quot;</span>, <span class="hljs-string">&quot;GetAllTaskResponse&quot;</span>, items
        );

        socket.<span class="hljs-title function_">send</span>(response);
    }

    <span class="hljs-meta">@Message</span>(<span class="hljs-string">&quot;AddTaskRequest&quot;</span>)
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">add</span>(<span class="hljs-params"><span class="hljs-meta">@Data</span>() <span class="hljs-attr">data</span>: <span class="hljs-title class_">AddTaskRequest</span>, <span class="hljs-meta">@Socket</span>() socket</span>) {
        <span class="hljs-keyword">const</span> entity = <span class="hljs-title function_">plainToClass</span>(<span class="hljs-title class_">TaskEntity</span>, data.<span class="hljs-property">item</span>);
        <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskservice</span>.<span class="hljs-title function_">add</span>(entity);

        <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title class_">RpcUtils</span>.<span class="hljs-title function_">pack</span>(
            <span class="hljs-string">&quot;task&quot;</span>, <span class="hljs-string">&quot;AddTaskResponse&quot;</span>, 
            { <span class="hljs-attr">item</span>: result, <span class="hljs-attr">id</span>: result.<span class="hljs-property">id</span> }
        );

        <span class="hljs-title class_">CacheService</span>.<span class="hljs-title function_">set</span>(<span class="hljs-comment">// Manual cache update</span>
            <span class="hljs-string">`task:<span class="hljs-subst">${result.id}</span>`</span>, 
            <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(result), 
            <span class="hljs-number">300</span>
        ); 

        socket.<span class="hljs-title function_">send</span>(response);
    }

    <span class="hljs-meta">@Message</span>(<span class="hljs-string">&quot;UpdateTaskRequest&quot;</span>)
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">update</span>(<span class="hljs-params"><span class="hljs-meta">@Data</span>() <span class="hljs-attr">data</span>: <span class="hljs-title class_">UpdateTaskRequest</span>, <span class="hljs-meta">@Socket</span>() socket</span>) {
        <span class="hljs-keyword">const</span> entity = <span class="hljs-title function_">plainToClass</span>(<span class="hljs-title class_">TaskEntity</span>, data.<span class="hljs-property">item</span>);
        <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskservice</span>.<span class="hljs-title function_">update</span>(data.<span class="hljs-property">id</span>, entity);

        <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title class_">RpcUtils</span>.<span class="hljs-title function_">pack</span>(
            <span class="hljs-string">&quot;task&quot;</span>, <span class="hljs-string">&quot;UpdateTaskResponse&quot;</span>, 
            {  <span class="hljs-attr">item</span>: result, <span class="hljs-attr">id</span>: result.<span class="hljs-property">id</span> }
        );

        <span class="hljs-title class_">CacheService</span>.<span class="hljs-title function_">set</span>(<span class="hljs-comment">// Manual cache update</span>
            <span class="hljs-string">`task:<span class="hljs-subst">${result.id}</span>`</span>, 
            <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(result), 
            <span class="hljs-number">300</span>
        ); 

        socket.<span class="hljs-title function_">send</span>(response);
    }

    <span class="hljs-meta">@Message</span>(<span class="hljs-string">&quot;DeleteTaskRequest&quot;</span>)
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params"><span class="hljs-meta">@Data</span>() <span class="hljs-attr">data</span>: <span class="hljs-title class_">DeleteTaskRequest</span>, <span class="hljs-meta">@Socket</span>() socket</span>) {
        <span class="hljs-keyword">const</span> result = (<span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskservice</span>.<span class="hljs-title function_">delete</span>(data.<span class="hljs-property">id</span>)).<span class="hljs-property">success</span>;

        <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title class_">RpcUtils</span>.<span class="hljs-title function_">pack</span>(
            <span class="hljs-string">&quot;task&quot;</span>, 
            <span class="hljs-string">&quot;DeleteTaskResponse&quot;</span>, 
            { <span class="hljs-attr">success</span>: result, <span class="hljs-attr">id</span>: data.<span class="hljs-property">id</span> }
        );

        <span class="hljs-title class_">CacheService</span>.<span class="hljs-title function_">del</span>(<span class="hljs-string">`task:<span class="hljs-subst">${data.id}</span>`</span>); <span class="hljs-comment">// Cache deletion</span>
        
        socket.<span class="hljs-title function_">send</span>(response);
    }
}
</code></pre>
             </div>
<br/>
<ul>
<li><strong>Automatic Caching:</strong> The <code>@Cache</code> decorator is applied to message handlers to cache responses based on the contract configuration.</li>
<li><strong>Manual Cache Management:</strong> Cache entries are manually updated or deleted when data is added, updated, or deleted, ensuring consistency.</li>
<li><strong>Performance Improvement:</strong> Cached responses reduce the need for repeated service calls, improving the performance of RPC interactions.</li>
</ul>
