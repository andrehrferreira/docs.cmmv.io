<h1>Transpiles</h1><a id="transpiles" title="Transpiles"></a>
<p>In the CMMV framework, transpilers are essential tools used to generate necessary files based on contracts and module requirements. These classes automatically create code or configuration files that are vital for the proper functioning of modules such as HTTP, Protobuf, and Repository.</p>
<p>Whenever a module requires specific artifacts, like controllers, entities, or Protobuf definitions, a transpiler processes the contracts and generates the required files. This approach ensures modularity and adaptability, as each module can define its own set of transpilers to handle file generation as needed.</p>
<h2>Key Features of Transpilers</h2><a id="key-features-of-transpilers" title="Key Features of Transpilers"></a>
<ul>
<li><strong>Automatic Code Generation:</strong> Transpilers generate files automatically based on contracts, reducing manual work and ensuring consistency between your application and the database, API interfaces, or other modules.</li>
<li><strong>Modular:</strong> Each module (e.g., HTTP, Protobuf, Repository) has its own transpiler, ensuring a clean separation of concerns.</li>
<li><strong>Customizable:</strong> New transpilers can be added for other custom modules, making the system extensible.</li>
<li><strong>Contract-Based:</strong> Transpilers rely on contracts to define what code needs to be generated. Contracts are the central mechanism for defining the structure, behavior, and data types for entities and services.</li>
</ul>
<h2>Native Transpilers</h2><a id="native-transpilers" title="Native Transpilers"></a>
<ul>
<li><strong>Protobuf Transpiler:</strong> Generates .proto files based on contracts to enable RPC communication.</li>
<li><strong>Repository Transpiler:</strong> Creates database entities based on TypeORM, implementing CRUD functionality based on contracts.</li>
<li><strong>HTTP Transpiler:</strong> Generates controllers and routes for RESTful APIs based on the contract definitions.</li>
<li><strong>Websocket Transpiler:</strong> Generates Websocket communication gateways for RPC based on contract definitions.</li>
</ul>
<h2>Example</h2><a id="example" title="Example"></a>
<p>Below is an implementation of the ProtobufTranspile class, which generates <code>.proto</code> files from contracts to facilitate communication using Protobuf.</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;fs&#x27;</span>;
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;path&#x27;</span>;
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> protobufjs <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;protobufjs&#x27;</span>;
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-title class_">UglifyJS</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;uglify-js&#x27;</span>;

<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ProtoRegistry</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./protobuf-registry.utils&#x27;</span>;

<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ITranspile</span>, <span class="hljs-title class_">Logger</span>, <span class="hljs-title class_">Scope</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@cmmv/core&quot;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProtobufTranspile</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ITranspile</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-attr">logger</span>: <span class="hljs-title class_">Logger</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Logger</span>(<span class="hljs-string">&#x27;ProtobufTranspile&#x27;</span>);

    <span class="hljs-title function_">run</span>(): <span class="hljs-built_in">void</span> {
        <span class="hljs-keyword">const</span> contracts = <span class="hljs-title class_">Scope</span>.<span class="hljs-property">getArray</span>&lt;<span class="hljs-built_in">any</span>&gt;(<span class="hljs-string">&quot;__contracts&quot;</span>);

        <span class="hljs-keyword">const</span> <span class="hljs-attr">contractsJson</span>: { [<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">any</span> } = {};

        contracts?.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">contract</span>: <span class="hljs-built_in">any</span></span>) =&gt;</span> {
            <span class="hljs-keyword">const</span> outputPath = path.<span class="hljs-title function_">resolve</span>(contract.<span class="hljs-property">protoPath</span>);
            <span class="hljs-keyword">const</span> outputPathJson = outputPath.<span class="hljs-title function_">replace</span>(<span class="hljs-string">&#x27;.proto&#x27;</span>, <span class="hljs-string">&#x27;.json&#x27;</span>);
            <span class="hljs-keyword">const</span> outputPathTs = outputPath.<span class="hljs-title function_">replace</span>(<span class="hljs-string">&#x27;.proto&#x27;</span>, <span class="hljs-string">&#x27;.d.ts&#x27;</span>);
            <span class="hljs-keyword">const</span> outputDir = path.<span class="hljs-title function_">dirname</span>(outputPath);    
                               
            <span class="hljs-keyword">if</span> (!fs.<span class="hljs-title function_">existsSync</span>(outputDir)) {
                fs.<span class="hljs-title function_">mkdirSync</span>(outputDir, { <span class="hljs-attr">recursive</span>: <span class="hljs-literal">true</span> });
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Created directory <span class="hljs-subst">${outputDir}</span>`</span>);
            }

            <span class="hljs-keyword">const</span> root = <span class="hljs-keyword">new</span> protobufjs.<span class="hljs-title class_">Root</span>();
            <span class="hljs-keyword">const</span> protoNamespace = root.<span class="hljs-title function_">define</span>(contract.<span class="hljs-property">controllerName</span>);

            <span class="hljs-keyword">const</span> itemMessage = <span class="hljs-keyword">new</span> protobufjs.<span class="hljs-title class_">Type</span>(contract.<span class="hljs-property">controllerName</span>)
                .<span class="hljs-title function_">add</span>(<span class="hljs-keyword">new</span> protobufjs.<span class="hljs-title class_">Field</span>(<span class="hljs-string">&quot;id&quot;</span>, <span class="hljs-number">1</span>, <span class="hljs-string">&quot;int32&quot;</span>));

            contract.<span class="hljs-property">fields</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">field</span>: <span class="hljs-built_in">any</span>, <span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span></span>) =&gt;</span> {
                <span class="hljs-keyword">const</span> protoType = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">mapToProtoType</span>(field.<span class="hljs-property">protoType</span>);
                itemMessage.<span class="hljs-title function_">add</span>(<span class="hljs-keyword">new</span> protobufjs.<span class="hljs-title class_">Field</span>(field.<span class="hljs-property">propertyKey</span>, index + <span class="hljs-number">2</span>, protoType));
            });

            protoNamespace.<span class="hljs-title function_">add</span>(itemMessage);

            <span class="hljs-keyword">if</span> (!contract.<span class="hljs-property">directMessage</span>) {
                <span class="hljs-keyword">const</span> listMessage = <span class="hljs-keyword">new</span> protobufjs.<span class="hljs-title class_">Type</span>(<span class="hljs-string">`<span class="hljs-subst">${contract.controllerName}</span>List`</span>)
                    .<span class="hljs-title function_">add</span>(<span class="hljs-keyword">new</span> protobufjs.<span class="hljs-title class_">Field</span>(<span class="hljs-string">&quot;items&quot;</span>, <span class="hljs-number">1</span>, <span class="hljs-string">`<span class="hljs-subst">${contract.controllerName}</span>`</span>, <span class="hljs-string">&quot;repeated&quot;</span>));

                protoNamespace.<span class="hljs-title function_">add</span>(listMessage);
            }

            <span class="hljs-keyword">const</span> protoContent = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">generateProtoContent</span>(contract);
            fs.<span class="hljs-title function_">writeFileSync</span>(outputPath, protoContent, <span class="hljs-string">&#x27;utf8&#x27;</span>);

            <span class="hljs-keyword">const</span> tsContent = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">generateTypes</span>(contract);
            fs.<span class="hljs-title function_">writeFileSync</span>(outputPathTs, tsContent, <span class="hljs-string">&#x27;utf8&#x27;</span>);

            <span class="hljs-keyword">const</span> contractJSON = root.<span class="hljs-title function_">toJSON</span>();
            contractsJson[contract.<span class="hljs-property">controllerName</span>] = contractJSON;
            fs.<span class="hljs-title function_">writeFileSync</span>(outputPathJson, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(contractJSON), <span class="hljs-string">&#x27;utf8&#x27;</span>);
        });

        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">generateContractsJs</span>(contractsJson);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-title function_">generateProtoContent</span>(<span class="hljs-attr">contract</span>: <span class="hljs-built_in">any</span>): <span class="hljs-built_in">string</span> {
        <span class="hljs-keyword">const</span> packageName = contract.<span class="hljs-property">protoPackage</span> || <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">const</span> <span class="hljs-attr">lines</span>: <span class="hljs-built_in">string</span>[] = [];
        <span class="hljs-keyword">let</span> includesGoogleAny = <span class="hljs-literal">false</span>;
    
        contract.<span class="hljs-property">fields</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">field</span>: <span class="hljs-built_in">any</span></span>) =&gt;</span> {
            <span class="hljs-keyword">if</span> (field.<span class="hljs-property">protoType</span> === <span class="hljs-string">&#x27;any&#x27;</span>) 
                includesGoogleAny = <span class="hljs-literal">true</span>;        
        });
    
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">&#x27;// Generated automatically by CMMV&#x27;</span>);
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`syntax = &quot;proto3&quot;;`</span>);
    
        <span class="hljs-keyword">if</span> (packageName)
            lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`package <span class="hljs-subst">${packageName}</span>;`</span>);
    
        <span class="hljs-keyword">if</span> (includesGoogleAny) 
            lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">&#x27;import &quot;google/protobuf/any.proto&quot;;&#x27;</span>);
            
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">&#x27;&#x27;</span>);
    
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`message <span class="hljs-subst">${contract.controllerName}</span> {`</span>);
    
        contract.<span class="hljs-property">fields</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">field</span>: <span class="hljs-built_in">any</span>, <span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span></span>) =&gt;</span> {
            <span class="hljs-keyword">const</span> protoType = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">mapToProtoType</span>(field.<span class="hljs-property">protoType</span>);
            <span class="hljs-keyword">const</span> repeatedPrefix = field.<span class="hljs-property">protoRepeated</span> ? <span class="hljs-string">&#x27;repeated &#x27;</span> : <span class="hljs-string">&#x27;&#x27;</span>;
            lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`  <span class="hljs-subst">${repeatedPrefix}</span><span class="hljs-subst">${protoType}</span> <span class="hljs-subst">${field.propertyKey}</span> = <span class="hljs-subst">${index + <span class="hljs-number">1</span>}</span>;`</span>);
        });
    
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`}`</span>);
    
        <span class="hljs-keyword">if</span> (!contract.<span class="hljs-property">directMessage</span>) {
            lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">&#x27;&#x27;</span>);
            lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`message <span class="hljs-subst">${contract.controllerName}</span>List {`</span>);
            lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`  repeated <span class="hljs-subst">${contract.controllerName}</span> items = 1;`</span>);
            lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`}`</span>);
        }
    
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">&#x27;&#x27;</span>);
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`message Add<span class="hljs-subst">${contract.controllerName}</span>Request {`</span>);
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`  <span class="hljs-subst">${contract.controllerName}</span> item = 1;`</span>);
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`}`</span>);
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`message Add<span class="hljs-subst">${contract.controllerName}</span>Response {`</span>);
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`  string id = 1;`</span>); 
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`  <span class="hljs-subst">${contract.controllerName}</span> item = 2;`</span>);
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`}`</span>);
        
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">&#x27;&#x27;</span>);
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`message Update<span class="hljs-subst">${contract.controllerName}</span>Request {`</span>);
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`  string id = 1;`</span>); 
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`  <span class="hljs-subst">${contract.controllerName}</span> item = 2;`</span>);
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`}`</span>);
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`message Update<span class="hljs-subst">${contract.controllerName}</span>Response {`</span>);
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`  string id = 1;`</span>); 
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`  <span class="hljs-subst">${contract.controllerName}</span> item = 2;`</span>);
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`}`</span>);
    
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">&#x27;&#x27;</span>);
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`message Delete<span class="hljs-subst">${contract.controllerName}</span>Request {`</span>);
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`  string id = 1;`</span>);
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`}`</span>);
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`message Delete<span class="hljs-subst">${contract.controllerName}</span>Response {`</span>);
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`  bool success = 1;`</span>);
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`  string id = 2;`</span>);
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`}`</span>);
    
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">&#x27;&#x27;</span>);
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`message GetAll<span class="hljs-subst">${contract.controllerName}</span>Request {}`</span>);
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`message GetAll<span class="hljs-subst">${contract.controllerName}</span>Response {`</span>);
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`  <span class="hljs-subst">${contract.controllerName}</span>List items = 1;`</span>);
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`}`</span>);
    
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">&#x27;&#x27;</span>);
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`service <span class="hljs-subst">${contract.controllerName}</span>Service {`</span>);
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`  rpc Add<span class="hljs-subst">${contract.controllerName}</span> (Add<span class="hljs-subst">${contract.controllerName}</span>Request) returns (Add<span class="hljs-subst">${contract.controllerName}</span>Response);`</span>);
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`  rpc Update<span class="hljs-subst">${contract.controllerName}</span> (Update<span class="hljs-subst">${contract.controllerName}</span>Request) returns (Update<span class="hljs-subst">${contract.controllerName}</span>Response);`</span>);
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`  rpc Delete<span class="hljs-subst">${contract.controllerName}</span> (Delete<span class="hljs-subst">${contract.controllerName}</span>Request) returns (Delete<span class="hljs-subst">${contract.controllerName}</span>Response);`</span>);
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`  rpc GetAll<span class="hljs-subst">${contract.controllerName}</span> (GetAll<span class="hljs-subst">${contract.controllerName}</span>Request) returns (GetAll<span class="hljs-subst">${contract.controllerName}</span>Response);`</span>);
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`}`</span>);
    
        <span class="hljs-keyword">return</span> lines.<span class="hljs-title function_">join</span>(<span class="hljs-string">&#x27;\n&#x27;</span>);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-title function_">generateTypes</span>(<span class="hljs-attr">contract</span>: <span class="hljs-built_in">any</span>): <span class="hljs-built_in">string</span> {
        <span class="hljs-keyword">const</span> <span class="hljs-attr">lines</span>: <span class="hljs-built_in">string</span>[] = [];
    
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`// Types generated automatically by CMMV`</span>);
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`export namespace <span class="hljs-subst">${contract.controllerName}</span> {`</span>);
    
        contract.<span class="hljs-property">fields</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">field</span>: <span class="hljs-built_in">any</span></span>) =&gt;</span> {
            <span class="hljs-keyword">const</span> tsType = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">mapToTsType</span>(field.<span class="hljs-property">protoType</span>);
            lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`  export type <span class="hljs-subst">${field.propertyKey}</span> = <span class="hljs-subst">${tsType}</span>;`</span>);
        });
    
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`}`</span>);
        
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`export interface Add<span class="hljs-subst">${contract.controllerName}</span>Request {`</span>);
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`  item: <span class="hljs-subst">${contract.controllerName}</span>;`</span>);
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`}`</span>);
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`export interface Add<span class="hljs-subst">${contract.controllerName}</span>Response {`</span>);
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`  item: <span class="hljs-subst">${contract.controllerName}</span>;`</span>);
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`}`</span>);
        
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`export interface Update<span class="hljs-subst">${contract.controllerName}</span>Request {`</span>);
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`  id: string;`</span>);
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`  item: <span class="hljs-subst">${contract.controllerName}</span>;`</span>);
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`}`</span>);
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`export interface Update<span class="hljs-subst">${contract.controllerName}</span>Response {`</span>);
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`  item: <span class="hljs-subst">${contract.controllerName}</span>;`</span>);
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`}`</span>);
        
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`export interface Delete<span class="hljs-subst">${contract.controllerName}</span>Request {`</span>);
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`  id: string;`</span>);
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`}`</span>);
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`export interface Delete<span class="hljs-subst">${contract.controllerName}</span>Response {`</span>);
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`  success: boolean;`</span>);
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`}`</span>);
        
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`export interface GetAll<span class="hljs-subst">${contract.controllerName}</span>Request {}`</span>);
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`export interface GetAll<span class="hljs-subst">${contract.controllerName}</span>Response {`</span>);
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`  items: <span class="hljs-subst">${contract.controllerName}</span>[];`</span>);
        lines.<span class="hljs-title function_">push</span>(<span class="hljs-string">`}`</span>);
    
        <span class="hljs-keyword">return</span> lines.<span class="hljs-title function_">join</span>(<span class="hljs-string">&#x27;\n&#x27;</span>);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">generateContractsJs</span>(<span class="hljs-attr">contractsJson</span>: { [<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">any</span> }): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
        <span class="hljs-keyword">const</span> outputFile = path.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;public/core/contracts.min.js&#x27;</span>);
    
        <span class="hljs-keyword">await</span> <span class="hljs-title class_">ProtoRegistry</span>.<span class="hljs-title function_">load</span>();
        <span class="hljs-keyword">const</span> contracts = <span class="hljs-title class_">ProtoRegistry</span>.<span class="hljs-title function_">retrieveAll</span>();
        <span class="hljs-keyword">let</span> contractsJSON = {};
        <span class="hljs-keyword">let</span> index = {};
        <span class="hljs-keyword">let</span> pointer = <span class="hljs-number">0</span>;

        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> key <span class="hljs-keyword">in</span> contracts){
            <span class="hljs-keyword">const</span> contract = <span class="hljs-title class_">ProtoRegistry</span>.<span class="hljs-title function_">retrieve</span>(key);
            contractsJSON[key] = contract.<span class="hljs-title function_">toJSON</span>();
            <span class="hljs-keyword">let</span> types = {};
            <span class="hljs-keyword">let</span> pointerTypes = <span class="hljs-number">0</span>;

            <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> <span class="hljs-keyword">namespace</span> <span class="hljs-title class_">of</span> contract.<span class="hljs-property">nestedArray</span>){
                <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> <span class="hljs-keyword">type</span> <span class="hljs-keyword">in</span> namespace.<span class="hljs-title function_">toJSON</span>().<span class="hljs-property">nested</span>){
                    types[<span class="hljs-keyword">type</span>] = pointerTypes;   
                    pointerTypes++;
                }                                 
            }
            
            index[key] = { <span class="hljs-attr">index</span>: pointer, types };
            pointer++;
        }

        <span class="hljs-keyword">const</span> data = {
            index,
            <span class="hljs-attr">contracts</span>: contractsJSON
        };
    
        <span class="hljs-keyword">let</span> jsContent = <span class="hljs-string">&#x27;// Generated automatically by CMMV\n&#x27;</span>;
        jsContent += <span class="hljs-string">&#x27;(function(global) {\n&#x27;</span>;
        jsContent += <span class="hljs-string">&#x27;  try {\n&#x27;</span>;
        jsContent += <span class="hljs-string">&#x27;    global.cmmv.addContracts(&#x27;</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data) + <span class="hljs-string">&#x27;);\n&#x27;</span>;
        jsContent += <span class="hljs-string">&#x27;  } catch (e) {\n&#x27;</span>;
        jsContent += <span class="hljs-string">&#x27;    console.error(&quot;Error loading contracts:&quot;, e);\n&#x27;</span>;
        jsContent += <span class="hljs-string">&#x27;  }\n&#x27;</span>;
        jsContent += <span class="hljs-string">&#x27;})(typeof window !== &quot;undefined&quot; ? window : global);\n&#x27;</span>;
    
        <span class="hljs-keyword">const</span> minifiedJsContent = <span class="hljs-title class_">UglifyJS</span>.<span class="hljs-title function_">minify</span>(jsContent).<span class="hljs-property">code</span>;
    
        fs.<span class="hljs-title function_">writeFileSync</span>(outputFile, minifiedJsContent, <span class="hljs-string">&#x27;utf8&#x27;</span>);
    }  
    
    <span class="hljs-keyword">private</span> <span class="hljs-title function_">mapToProtoType</span>(<span class="hljs-attr">type</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">string</span> {
        <span class="hljs-keyword">const</span> <span class="hljs-attr">typeMapping</span>: { [<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">string</span> } = {
            <span class="hljs-attr">string</span>: <span class="hljs-string">&#x27;string&#x27;</span>,
            <span class="hljs-attr">boolean</span>: <span class="hljs-string">&#x27;bool&#x27;</span>,
            <span class="hljs-attr">bool</span>: <span class="hljs-string">&#x27;bool&#x27;</span>,
            <span class="hljs-attr">int</span>: <span class="hljs-string">&#x27;int32&#x27;</span>,
            <span class="hljs-attr">int32</span>: <span class="hljs-string">&#x27;int32&#x27;</span>,
            <span class="hljs-attr">int64</span>: <span class="hljs-string">&#x27;int64&#x27;</span>,
            <span class="hljs-attr">float</span>: <span class="hljs-string">&#x27;float&#x27;</span>,
            <span class="hljs-attr">double</span>: <span class="hljs-string">&#x27;double&#x27;</span>,
            <span class="hljs-attr">bytes</span>: <span class="hljs-string">&#x27;bytes&#x27;</span>,
            <span class="hljs-attr">date</span>: <span class="hljs-string">&#x27;string&#x27;</span>,          
            <span class="hljs-attr">timestamp</span>: <span class="hljs-string">&#x27;string&#x27;</span>,     
            <span class="hljs-attr">text</span>: <span class="hljs-string">&#x27;string&#x27;</span>,          
            <span class="hljs-attr">json</span>: <span class="hljs-string">&#x27;string&#x27;</span>,          
            <span class="hljs-attr">jsonb</span>: <span class="hljs-string">&#x27;string&#x27;</span>,         
            <span class="hljs-attr">uuid</span>: <span class="hljs-string">&#x27;string&#x27;</span>,          
            <span class="hljs-attr">time</span>: <span class="hljs-string">&#x27;string&#x27;</span>,          
            <span class="hljs-attr">simpleArray</span>: <span class="hljs-string">&#x27;string&#x27;</span>,   
            <span class="hljs-attr">simpleJson</span>: <span class="hljs-string">&#x27;string&#x27;</span>,    
            <span class="hljs-attr">bigint</span>: <span class="hljs-string">&#x27;int64&#x27;</span>,
            <span class="hljs-attr">uint32</span>: <span class="hljs-string">&#x27;uint32&#x27;</span>,
            <span class="hljs-attr">uint64</span>: <span class="hljs-string">&#x27;uint64&#x27;</span>,
            <span class="hljs-attr">sint32</span>: <span class="hljs-string">&#x27;sint32&#x27;</span>,
            <span class="hljs-attr">sint64</span>: <span class="hljs-string">&#x27;sint64&#x27;</span>,
            <span class="hljs-attr">fixed32</span>: <span class="hljs-string">&#x27;fixed32&#x27;</span>,
            <span class="hljs-attr">fixed64</span>: <span class="hljs-string">&#x27;fixed64&#x27;</span>,
            <span class="hljs-attr">sfixed32</span>: <span class="hljs-string">&#x27;sfixed32&#x27;</span>,
            <span class="hljs-attr">sfixed64</span>: <span class="hljs-string">&#x27;sfixed64&#x27;</span>,
            <span class="hljs-attr">any</span>: <span class="hljs-string">&#x27;google.protobuf.Any&#x27;</span>
        };
    
        <span class="hljs-keyword">return</span> typeMapping[<span class="hljs-keyword">type</span>] || <span class="hljs-string">&#x27;string&#x27;</span>;
    }  
    
    <span class="hljs-keyword">private</span> <span class="hljs-title function_">mapToTsType</span>(<span class="hljs-attr">protoType</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">string</span> {
        <span class="hljs-keyword">const</span> <span class="hljs-attr">typeMapping</span>: { [<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">string</span> } = {
            <span class="hljs-attr">string</span>: <span class="hljs-string">&#x27;string&#x27;</span>,
            <span class="hljs-attr">boolean</span>: <span class="hljs-string">&#x27;boolean&#x27;</span>,
            <span class="hljs-attr">bool</span>: <span class="hljs-string">&#x27;boolean&#x27;</span>,
            <span class="hljs-attr">int</span>: <span class="hljs-string">&#x27;number&#x27;</span>,
            <span class="hljs-attr">int32</span>: <span class="hljs-string">&#x27;number&#x27;</span>,
            <span class="hljs-attr">int64</span>: <span class="hljs-string">&#x27;number&#x27;</span>,
            <span class="hljs-attr">float</span>: <span class="hljs-string">&#x27;number&#x27;</span>,
            <span class="hljs-attr">double</span>: <span class="hljs-string">&#x27;number&#x27;</span>,
            <span class="hljs-attr">bytes</span>: <span class="hljs-string">&#x27;Uint8Array&#x27;</span>,
            <span class="hljs-attr">date</span>: <span class="hljs-string">&#x27;string&#x27;</span>,
            <span class="hljs-attr">timestamp</span>: <span class="hljs-string">&#x27;string&#x27;</span>,
            <span class="hljs-attr">text</span>: <span class="hljs-string">&#x27;string&#x27;</span>,
            <span class="hljs-attr">json</span>: <span class="hljs-string">&#x27;any&#x27;</span>,
            <span class="hljs-attr">jsonb</span>: <span class="hljs-string">&#x27;any&#x27;</span>,
            <span class="hljs-attr">uuid</span>: <span class="hljs-string">&#x27;string&#x27;</span>,
            <span class="hljs-attr">time</span>: <span class="hljs-string">&#x27;string&#x27;</span>,
            <span class="hljs-attr">simpleArray</span>: <span class="hljs-string">&#x27;string[]&#x27;</span>,
            <span class="hljs-attr">simpleJson</span>: <span class="hljs-string">&#x27;any&#x27;</span>,
            <span class="hljs-attr">bigint</span>: <span class="hljs-string">&#x27;bigint&#x27;</span>,
            <span class="hljs-attr">uint32</span>: <span class="hljs-string">&#x27;number&#x27;</span>,
            <span class="hljs-attr">uint64</span>: <span class="hljs-string">&#x27;number&#x27;</span>,
            <span class="hljs-attr">sint32</span>: <span class="hljs-string">&#x27;number&#x27;</span>,
            <span class="hljs-attr">sint64</span>: <span class="hljs-string">&#x27;number&#x27;</span>,
            <span class="hljs-attr">fixed32</span>: <span class="hljs-string">&#x27;number&#x27;</span>,
            <span class="hljs-attr">fixed64</span>: <span class="hljs-string">&#x27;number&#x27;</span>,
            <span class="hljs-attr">sfixed32</span>: <span class="hljs-string">&#x27;number&#x27;</span>,
            <span class="hljs-attr">sfixed64</span>: <span class="hljs-string">&#x27;number&#x27;</span>,
            <span class="hljs-attr">any</span>: <span class="hljs-string">&#x27;any&#x27;</span>
        };
    
        <span class="hljs-keyword">return</span> typeMapping[protoType] || <span class="hljs-string">&#x27;any&#x27;</span>;
    }
}
</code></pre>
<p>In the example above, the Protobuf transpiler takes contract definitions and generates .proto files to be used for RPC communication with the protobufjs library. These .proto files define message structures for binary data exchanges. Additionally, TypeScript types are generated based on these contracts to ensure type safety. Finally, the contracts are converted into JSON format and attached to the frontend framework, which will handle the sending and receiving of binary data in the Protobuf format, enabling efficient data communication between frontend and backend.</p>
<h2>Call a Transpiler</h2><a id="call-a-transpiler" title="Call a Transpiler"></a>
<p>In CMMV, transpilers are modular, which allows them to be dynamically added to modules and invoked during the application processing. A transpiler’s role is to automatically generate necessary files (such as entities, services, and Protobuf definitions) based on the contracts defined in your application.</p>
<p><code>/packages/protobuf/src/protobuf.module.ts</code></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Module</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@cmmv/core&quot;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ProtobufTranspile</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./protobuf.transpiler&quot;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> <span class="hljs-title class_">ProtobufModule</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Module</span>({
    <span class="hljs-attr">transpilers</span>: [<span class="hljs-title class_">ProtobufTranspile</span>] <span class="hljs-comment">// Register the transpiler here</span>
});
</code></pre>
<p>In this case, ProtobufModule registers the ProtobufTranspile transpiler. The transpilers property in the Module configuration allows you to list all the transpilers that should be executed when the module is processed.</p>
<p>When the application is started, the transpiler will be invoked automatically as part of the module processing. Each module’s transpilers will run based on the contracts defined in the system, and they will generate the required files accordingly.</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Application</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@cmmv/core&quot;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ProtobufModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@cmmv/protobuf&quot;</span>;

<span class="hljs-keyword">new</span> <span class="hljs-title class_">Application</span>({
    ...
    <span class="hljs-attr">modules</span>: [<span class="hljs-title class_">ProtobufModule</span>], 
});
</code></pre>
<p>When the application starts, it will look for all modules, identify the transpilers within those modules, and run them in sequence. In this case, the ProtobufTranspile will process any contracts registered in the system and generate the corresponding Protobuf files.</p>
<p>This modular design makes it easy to extend the system by adding new transpilers for various tasks, such as generating database entities, Protobuf definitions, or other required files based on the contracts defined in your application.</p>
